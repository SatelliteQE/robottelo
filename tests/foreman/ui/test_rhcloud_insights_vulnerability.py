"""Tests for IoP Vulnerability service

:Requirement: RHCloud

:CaseAutomation: Automated

:CaseComponent: Insights-Vulnerability

:Team: Proton

:CaseImportance: High

"""

import pytest

from robottelo import constants


@pytest.fixture(scope='module')
def setup_content_for_iop(module_target_sat_insights, rhcloud_manifest_org):
    """Fixture to sync RHEL content repos"""
    satellite = module_target_sat_insights

    # Enable and sync BaseOS and AppStram repos
    for name in ['rhel10_bos', 'rhel10_aps']:
        # Enable the repository
        rh_repo_id = satellite.api_factory.enable_rhrepo_and_fetchid(
            basearch=constants.DEFAULT_ARCHITECTURE,
            org_id=rhcloud_manifest_org.id,
            product=constants.REPOS[name]['product'],
            repo=constants.REPOS[name]['name'],
            reposet=constants.REPOS[name]['reposet'],
            releasever=constants.REPOS[name]['releasever'],
        )

        # Sync the repository
        rh_repo = satellite.api.Repository(id=rh_repo_id).read()
        task = rh_repo.sync(synchronous=False)
        satellite.wait_for_tasks(
            search_query=(f'id = {task["id"]}'),
            poll_timeout=2500,
        )
        task_status = satellite.api.ForemanTask(id=task['id']).poll()
        assert task_status['result'] == 'success'

    # Manually trigger CVE sync
    assert satellite.execute('systemctl start iop-cvemap-download').status == 0
    assert satellite.execute('systemctl start iop-service-vuln-vmaas-sync').status == 0


@pytest.mark.e2e
@pytest.mark.no_containers
@pytest.mark.rhel_ver_list([10])
@pytest.mark.parametrize('module_target_sat_insights', [False], ids=['local'], indirect=True)
def test_rhcloud_insights_vulnerabilities_e2e(
    rhel_insights_vm,
    rhcloud_manifest_org,
    module_target_sat_insights,
    setup_content_for_iop,
):
    """Validate vulnerability data from local Insights,
        verify results are displayed correctly for impacted host in Satellite.

    :id: d952e83c-3faf-4299-a048-2eb6ccb8c9c3

    :steps:
        1. Enable local Insights/Red Hat Lightspeed on Satellite.
        2. Import Manifest, Sync RHEL content, and create AK with the content.
        3. Register a host using AK created.
        4. Downgrade package on host to create vulnerability for detection by vulnerability engine.
        5. In Satellite UI, go to Vulnerabilities tab on Host Details page and validate the data.
        6. In Satellite UI, go to Vulnerability page and validate the data.

    :expectedresults:
        1. Local insights vulnerability engine detects the new vulnerabilities.
        2. Vulnerability data is displayed correctly for impacted host in Satellite.

    :verifies: SAT-30762
    """
    CVE_ID = 'CVE-2025-8058'
    GLIBC_RPM = 'glibc-2.39-43.el10_0.x86_64'

    satellite = module_target_sat_insights
    client = rhel_insights_vm
    hostname = client.hostname

    # Remove any static repos and update to the latest packages available from the Satellite
    assert (
        client.execute(
            "find /etc/yum.repos.d/ -type f | grep -vF redhat.repo | xargs -I '{}' rm '{}'"
        ).status
        == 0
    )
    assert client.execute('dnf -y update').status == 0

    # Downgrade to vulnerable glibc version
    assert client.execute(f'dnf downgrade -y {GLIBC_RPM}').status == 0

    with satellite.ui_session() as session:
        session.organization.select(org_name=rhcloud_manifest_org.name)

        status = session.host_new.get_host_statuses(hostname)
        assert status['Red Hat Lightspeed']['Status'] == 'Reporting'

        vulnerabilities = session.host_new.get_vulnerabilities(hostname)
        assert any(vuln.get('CVE ID') == CVE_ID for vuln in vulnerabilities)

        # Validate the affected Host from the Vulnerability details and list pages
        affected_host = session.cloudvulnerability.get_affected_hosts_by_cve(CVE_ID)
        assert affected_host[0]['Name'] == hostname

        # Validate the Host's Vulnerabilities tab
        vulnerabilities = session.cloudvulnerability.validate_cve_to_host_details_flow(
            CVE_ID, hostname
        )
        assert any(vuln.get('CVE ID') == CVE_ID for vuln in vulnerabilities)
